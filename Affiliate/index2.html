<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Minter & Affiliate Script Test</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.2/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="style.css"> <!-- Ensure you have this CSS file -->
</head>
<body>
<div class="container">
    <h1>NFT Minting & Affiliate Script Test</h1>
    <form id="mintForm">
    <label for="nftName">NFT Name:</label>
    <input type="text" id="nftName" name="nftName" placeholder="Enter NFT name" required>

    <label for="nftDescription">NFT Description:</label>
    <input type="text" id="nftDescription" name="nftDescription" placeholder="Enter NFT description" required>

    <label for="nftPrice">NFT Price (in BNB):</label>
    <input type="text" id="nftPrice" name="nftPrice" placeholder="Enter NFT price" required>

    <input type="submit" id="submit-button" value="Mint NFT">
    <div id="loading" style="display: none;">Loading...</div>
    <div id="message"></div>
</form>
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', async () => {
    const mintForm = document.getElementById('mintForm');
    const submitButton = document.getElementById('submit-button');
    const loadingIndicator = document.getElementById('loading');
    const messageDiv = document.getElementById('message');

    async function isConnected() {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const accounts = await provider.listAccounts();
        return accounts.length > 0;
    }

    mintForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitButton.disabled = true;

        if (typeof window.ethereum === 'undefined') {
            console.log('Please install MetaMask!');
            messageDiv.innerText = 'Please install MetaMask!';
            messageDiv.style.color = 'red';
            submitButton.disabled = false;
            return;
        }

        try {
            loadingIndicator.style.display = 'block';

            if (!(await isConnected())) {
                await window.ethereum.request({ method: "eth_requestAccounts" });
            }

            const nftName = document.getElementById('nftName').value;
            const nftDescription = document.getElementById('nftDescription').value;
            const nftPriceInput = document.getElementById('nftPrice').value;

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const addressToSendNFTTo = await signer.getAddress();

            // Get the referring affiliate address
            const referringAffiliateAddress = await getReferringAffiliateAddress();

            const nftMintContractAddress = "0x81269B1Da46BF56395C198ee3fF7a274847e5e5f";
            const nftMintABI = [
                // Updated ABI based on IAffiliateTracker
                // Add the ABI here
            ];

            const nftContract = new ethers.Contract(nftMintContractAddress, nftMintABI, signer);

            // Get the default affiliate address
            const defaultAffiliateAddress = await getDefaultAffiliateAddress();

            // Determine the affiliate address to use
            const affiliateToUse = referringAffiliateAddress || defaultAffiliateAddress;

            const nftPriceWei = ethers.utils.parseEther(nftPriceInput);
            const uri = `data:application/json;base64,${btoa(JSON.stringify({ name: nftName, description: nftDescription }))}`;

            const overrides = {
                gasLimit: 9000000
            };

            // Call the mintNFT method from the deployed contract
            const transaction = await nftContract.mintNFT(addressToSendNFTTo, nftPriceWei, uri, affiliateToUse, overrides);

            await transaction.wait();

            console.log('NFT Minted successfully!');
            messageDiv.innerText = 'NFT Minted successfully!';
            messageDiv.style.color = 'green';
        } catch (error) {
            console.error('Error:', error);
            messageDiv.innerText = 'Error: ' + error.message;
            messageDiv.style.color = 'red';
        } finally {
            loadingIndicator.style.display = 'none';
            submitButton.disabled = false;
            mintForm.reset();
        }
    });

   async function getReferringAffiliateAddress() {
    const affiliateTrackerAddress = "0x123..."; // Replace with the actual address of your deployed AffiliateTracker contract
    const affiliateTrackerABI = [
        // Add the ABI of your AffiliateTracker contract here
    ];
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const affiliateTracker = new ethers.Contract(affiliateTrackerAddress, affiliateTrackerABI, signer);
    return await affiliateTracker.getReferringAffiliateAddress();
}

async function getDefaultAffiliateAddress() {
    const affiliateTrackerAddress = "0x123..."; // Replace with the actual address of your deployed AffiliateTracker contract
    const affiliateTrackerABI = [
        // Add the ABI of your AffiliateTracker contract here
    ];
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const affiliateTracker = new ethers.Contract(affiliateTrackerAddress, affiliateTrackerABI, signer);
    return await affiliateTracker.getDefaultAffiliateAddress();
}

});

</script>

</body>
</html>
