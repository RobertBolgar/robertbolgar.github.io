<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Minting & Affiliate Script Test</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.2/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="style.css"> <!-- Ensure you have this CSS file -->
</head>
<body>
<div class="container">
    <h1>NFT Minting & Affiliate Script Test</h1>
    <form id="mintForm">
        <label for="nftName">NFT Name:</label>
        <input type="text" id="nftName" name="nftName" placeholder="Enter NFT name" required>

        <label for="nftDescription">NFT Description:</label>
        <input type="text" id="nftDescription" name="nftDescription" placeholder="Enter NFT description" required>

        <label for="nftPrice">NFT Price (in BNB):</label>
        <input type="text" id="nftPrice" name="nftPrice" placeholder="Enter NFT price" required>

        <input type="submit" value="Mint NFT">
    </form>
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', () => {
    const mintForm = document.getElementById('mintForm');
    mintForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (typeof window.ethereum === 'undefined') {
            console.log('Please install MetaMask!');
            return;
        }

        try {
            const nftName = document.getElementById('nftName').value;
            const nftDescription = document.getElementById('nftDescription').value;
            const nftPrice = ethers.utils.parseEther(document.getElementById('nftPrice').value); // Parse as units of ether
            const uri = `data:application/json;base64,${btoa(JSON.stringify({ name: nftName, description: nftDescription }))}`;

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();

            const urlParams = new URLSearchParams(window.location.search);
            const affiliateCode = urlParams.get('affiliate'); // Extract affiliate code from URL query parameter

            const nftMintContractAddress = "0xbeB397c1a482D6739b71c357aB5D1cf4654342e1";
            
            const nftMintABI = [
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "approve",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "name",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "symbol",
                "type": "string"
            },
            {
                "internalType": "address",
                "name": "_affiliateTrackerAddress",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "initialOwner",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "_defaultAffiliate",
                "type": "address"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "sender",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            },
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "ERC721IncorrectOwner",
        "type": "error"
    },
    {
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "tokenPrices",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "tokenSellers",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "tokenURI",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
];



            const nftContract = new ethers.Contract(nftMintContractAddress, nftMintABI, signer);
            
            // Pass the affiliate code along with minting transaction
            const transaction = await nftContract.safeMint(signer.getAddress(), nftPrice, uri, affiliateCode || ethers.constants.AddressZero); // Use a default affiliate code if none is provided
            await transaction.wait(); // Wait for the transaction to be confirmed

            console.log('NFT Minted successfully!');
        } catch (error) {
            console.error('Error:', error);
            if (error.code === -32603) {
                console.error('Internal JSON-RPC error. Please check your MetaMask connection and try again.');
            }
        }
    });
});
</script>
</body>
</html>
